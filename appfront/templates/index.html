<!DOCTYPE html>
<html lang="cn">
<head>
 <meta charset="UTF-8">
 <title>界面简单粗暴但功能强大的转谱工具</title>
 <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js">
 </script>
</head>
<body>

<form id="convert_form" enctype="multipart/form-data">
 {% csrf_token %}
 <input type="file" name="map" id="convert_file" accept=".mc, .mcz, .zip"/>
</form>
<button id="convert_button">一键转谱</button>
<script>
  var uploading = false;
  var filename = null;
  var id = -1;

  function upload() {
    $.ajax({
      url: "/api/upload",
      type: 'POST',
      data: new FormData($('#convert_form')[0]),
      processData: false,
      contentType: false,
      dataType: "json",
      beforeSend: function () {
        $("#convert_button").text("转换中……");
        uploading = true;
      },
      success: function (data) {
        if (data.code === 1) {
          id = data.msg;
          filename = document.getElementById("convert_file").files[0].name;
          console.log(filename);
          download();
        } else {
          alert(data.msg);
        }
        $("#convert_button").text("一键转谱");
        uploading = false;
      }
    });
  }

  function download() {
    var voiceUrl = "/api/download?id=" + id;
    var iframe  = document.createElement("iframe");
    document.body.appendChild(iframe);
    iframe.src = voiceUrl;
    iframe.style.display = "none";
  }

  $("#convert_button").click(function () {
    if (uploading) {
      alert("正在处理，请稍后");
      return;
    }
    upload()
  });
</script>
</body>
</html>